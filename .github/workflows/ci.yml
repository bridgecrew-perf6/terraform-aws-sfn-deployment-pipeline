name: Tests
on: [push]
defaults:
  run:
    shell: bash

jobs:
  test:
    runs-on: ubuntu-latest
    container: vydev/terraform:0.12.29
    steps:
    - uses: actions/checkout@v2
    - name: Verify State Machine Definitions
      run: |
        #!/usr/bin/env bash
        set -euo pipefail
        IFS=$'\n\t'
        diffs=()
        cd test
        cp ../{payloads,states,variables}.tf .
        terraform init
        for test_case in cases/*; do
          cp "$test_case/terraform.tfvars" .
          cp "$test_case/expected.json" .
          terraform apply -auto-approve
          res="$(diff <(jq -S . expected.json) <(jq -S . generated.json) || true)"
          if [ -n "$res" ]; then
            diffs+=("$res")
          fi
        done
        if [ "${#diffs[@]}" -gt 0 ]; then
          printf "%s\n" "${diffs[@]}"
          exit 1
        fi
